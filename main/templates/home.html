{% extends 'base.html' %}


{% block title%}Home{% endblock%}

{% load static %}

{% block stylesheet %}
<link rel="stylesheet" href="{% static 'home.css'%}">
{% endblock %}

{%block content%}
    <div class="container">
        <h2>Následující cvičení</h2>
    </div>

{% endblock %}

{% block script %}
<script>
    var page = 1;
    var hasNext = true;
    
    function createLab({id, lab_date, close_login, close_logout, capacity, num_users, num_topics, applied}) {
        const anchor = document.createElement('a');
        anchor.setAttribute("href", `${window.location.origin}/event/${id}`);
        anchor.innerHTML = `
            <div class="lab-item ${applied ? 'applied-background': ''}">
                <h3>Laboratorní cvičení ${lab_date}</h3>
                <div class="lab-item-wrap">
                    <div>
                        <p>Datum uzávěru přihlášení: ${close_login}</p>
                        <p>Datum uzávěru odhlášení: ${close_logout}</p>
                    </div>
                    <div>
                        <p>Počet témat: ${num_topics}</p>
                        <p>Přihlášeni: ${num_users}/${capacity}</p>
                    </div>
                </div>
            </div>
        `
        return anchor;
    }

    async function load(container) {
        await fetch(`${window.location.origin}{% url 'api_events'%}?page=${page}`)
        .then(async response => {
            let json = await response.json();
            if (response.status >= 200 && response.status < 400) { 
                    page++;
                    hasNext = json.has_next;    
                    return json;
            } else {
                    throw new Error(json.message);
            }
        })
        .then(data => {
            return data.content.map(item => createLab(item))
        })
        .then(tags => tags.forEach(x => container.appendChild(x)))
        .catch(e => alert(e.message))
    }

    document.addEventListener("DOMContentLoaded", async () => {
        const container = document.querySelector(".container");

        while (document.body.offsetHeight <= window.innerHeight && hasNext) {
            await load(container);
        }

        window.onscroll = () => {
            // console.log(window.innerHeight + window.scrollY, document.body.offsetHeight)
            if ((window.innerHeight + window.scrollY >= document.body.offsetHeight) && hasNext) {
                 load(container);
            }
        }
    })

</script>

{% endblock %}
